name: Checkov PR Scan

on:
  pull_request:
    paths:
      - '**.md'
    branches:
      - main
  workflow_call:

jobs:
  checkov_scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        ref: ${{ github.head_ref }}

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.x

    - name: Cache Python packages
      uses: actions/cache@v2
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Checkov
      run: pip install checkov

    - name: Get changed Terraform files
      id: get_changed_files
      run: |
        echo "::set-output name=files::$(git diff --name-only --diff-filter=d origin/${{ github.base_ref }}..${{ github.head_ref }} -- '*.tf' | tr '\n' ' ')"

  process_results:
    needs: checkov_scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.x

    - name: Run Checkov
      id: checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: ${{ needs.checkov_scan.outputs.files }}
        output_format: json

    - name: Create comments with Checkov results
      uses: actions/github-script@v5
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const checks = JSON.parse(process.env.CHECKOV_OUTPUT);
          const files = [...new Set(checks.map((check) => check.file_path))];
          let output = '';
    
          if (files.length == 0) {
            output = `ðŸŒŸ No Terraform files were modified in this PR or all modified Terraform files passed the Checkov checks. Good job! ðŸŒŸ`;
          } else {
            for (const file of files) {
              const fileChecks = checks.filter((check) => check.file_path === file);
    
              output += `#### Checkov Scan Results ðŸ“– for file ${file}:\n\n` +
                `| Check ID | Description | Resource | Checkov Result |\n` +
                `| -------- | ----------- | -------- | -------------- |` +
                fileChecks
                  .map((check) => {
                    return `\n| ${check.check_id} | ${check.check_name} | ${check.resource} | ${check.check_result.result} |`;
                  })
                  .join("");
    
              if (fileChecks.every((check) => check.check_result.result === 'PASSED')) {
                output += '\nðŸŒŸ All checks passed! ðŸŒŸ';
              }
    
              output += `\n\n*Pusher: @${{ github.actor }}, Action: ${{ github.event_name }}, Working Directory: ${{ github.workspace }}, Workflow: ${{ github.workflow }}*\n\n`;
            }
          }
    
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: output
          });
