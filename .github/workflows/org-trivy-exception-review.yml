name: Trivy Exception Review

on:
  workflow_call:

permissions:
  contents: read
  issues: write

jobs:
  check_exceptions:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Check for expired exceptions
      id: check_expired
      run: |
        IGNORE_FILE=".trivyignore.yaml"

        if [ ! -f "$IGNORE_FILE" ]; then
          echo "No .trivyignore.yaml found"
          echo "has_expired=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        TODAY=$(date +%Y-%m-%d)
        EXPIRED_LIST=""
        EXPIRING_SOON_LIST=""
        THIRTY_DAYS_FROM_NOW=$(date -d "+30 days" +%Y-%m-%d 2>/dev/null || date -v+30d +%Y-%m-%d)

        # Parse YAML and check expiration dates
        # Using yq to parse the YAML file
        if ! command -v yq &> /dev/null; then
          echo "Installing yq..."
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
        fi

        # Check vulnerabilities section
        VULN_COUNT=$(yq '.vulnerabilities | length // 0' "$IGNORE_FILE")
        for i in $(seq 0 $((VULN_COUNT - 1))); do
          ID=$(yq ".vulnerabilities[$i].id" "$IGNORE_FILE")
          EXPIRED_AT=$(yq ".vulnerabilities[$i].expired_at // \"\"" "$IGNORE_FILE")
          STATEMENT=$(yq ".vulnerabilities[$i].statement // \"No statement provided\"" "$IGNORE_FILE")

          if [ -n "$EXPIRED_AT" ] && [ "$EXPIRED_AT" != "null" ]; then
            if [[ "$EXPIRED_AT" < "$TODAY" ]] || [[ "$EXPIRED_AT" == "$TODAY" ]]; then
              EXPIRED_LIST="${EXPIRED_LIST}\n| ${ID} | ${EXPIRED_AT} | ${STATEMENT} |"
            elif [[ "$EXPIRED_AT" < "$THIRTY_DAYS_FROM_NOW" ]]; then
              EXPIRING_SOON_LIST="${EXPIRING_SOON_LIST}\n| ${ID} | ${EXPIRED_AT} | ${STATEMENT} |"
            fi
          fi
        done

        # Check misconfigurations section
        MISCONFIG_COUNT=$(yq '.misconfigurations | length // 0' "$IGNORE_FILE")
        for i in $(seq 0 $((MISCONFIG_COUNT - 1))); do
          ID=$(yq ".misconfigurations[$i].id" "$IGNORE_FILE")
          EXPIRED_AT=$(yq ".misconfigurations[$i].expired_at // \"\"" "$IGNORE_FILE")
          STATEMENT=$(yq ".misconfigurations[$i].statement // \"No statement provided\"" "$IGNORE_FILE")

          if [ -n "$EXPIRED_AT" ] && [ "$EXPIRED_AT" != "null" ]; then
            if [[ "$EXPIRED_AT" < "$TODAY" ]] || [[ "$EXPIRED_AT" == "$TODAY" ]]; then
              EXPIRED_LIST="${EXPIRED_LIST}\n| ${ID} | ${EXPIRED_AT} | ${STATEMENT} |"
            elif [[ "$EXPIRED_AT" < "$THIRTY_DAYS_FROM_NOW" ]]; then
              EXPIRING_SOON_LIST="${EXPIRING_SOON_LIST}\n| ${ID} | ${EXPIRED_AT} | ${STATEMENT} |"
            fi
          fi
        done

        # Set outputs
        if [ -n "$EXPIRED_LIST" ]; then
          echo "has_expired=true" >> $GITHUB_OUTPUT
          {
            echo "expired_list<<EOF"
            echo -e "$EXPIRED_LIST"
            echo "EOF"
          } >> $GITHUB_OUTPUT
        else
          echo "has_expired=false" >> $GITHUB_OUTPUT
        fi

        if [ -n "$EXPIRING_SOON_LIST" ]; then
          echo "has_expiring_soon=true" >> $GITHUB_OUTPUT
          {
            echo "expiring_soon_list<<EOF"
            echo -e "$EXPIRING_SOON_LIST"
            echo "EOF"
          } >> $GITHUB_OUTPUT
        else
          echo "has_expiring_soon=false" >> $GITHUB_OUTPUT
        fi

    - name: Create issue for expired exceptions
      if: steps.check_expired.outputs.has_expired == 'true'
      uses: actions/github-script@v8
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const today = new Date().toISOString().split('T')[0];
          const expiredList = `${{ steps.check_expired.outputs.expired_list }}`;
          const expiringSoonList = `${{ steps.check_expired.outputs.expiring_soon_list }}`;
          const hasExpiringSoon = '${{ steps.check_expired.outputs.has_expiring_soon }}' === 'true';

          let body = `## SAST Exception Review Required\n\n`;
          body += `The following security exceptions in \`.trivyignore.yaml\` have expired and require review.\n\n`;
          body += `### Expired Exceptions\n\n`;
          body += `| Exception ID | Expired On | Original Statement |\n`;
          body += `| ------------ | ---------- | ------------------ |`;
          body += expiredList + '\n\n';

          if (hasExpiringSoon) {
            body += `### Expiring Within 30 Days\n\n`;
            body += `| Exception ID | Expires On | Statement |\n`;
            body += `| ------------ | ---------- | --------- |`;
            body += expiringSoonList + '\n\n';
          }

          body += `### Required Actions\n\n`;
          body += `For each expired exception, please:\n`;
          body += `1. **Re-evaluate** - Is this exception still needed?\n`;
          body += `2. **Remediate** - If possible, fix the underlying issue\n`;
          body += `3. **Renew** - If still needed, update \`expired_at\` with new date and document justification\n`;
          body += `4. **Remove** - If no longer applicable, remove the exception\n\n`;
          body += `---\n`;
          body += `*This issue was automatically created by the SAST Exception Review workflow.*`;

          // Check if there's already an open issue with this title
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security,sast-review'
          });

          const issueTitle = `SAST Exception Review - ${today}`;
          const existingIssue = existingIssues.data.find(issue =>
            issue.title.startsWith('SAST Exception Review')
          );

          if (existingIssue) {
            // Update existing issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: body
            });
            console.log(`Updated existing issue #${existingIssue.number}`);
          } else {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: body,
              labels: ['security', 'sast-review']
            });
            console.log('Created new SAST Exception Review issue');
          }

    - name: Generate summary
      if: always()
      run: |
        echo "## Trivy Exception Review" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.check_expired.outputs.has_expired }}" == "true" ]; then
          echo "### :warning: Expired Exceptions Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Exception ID | Expired On | Statement |" >> $GITHUB_STEP_SUMMARY
          echo "| ------------ | ---------- | --------- |" >> $GITHUB_STEP_SUMMARY
          echo -e "${{ steps.check_expired.outputs.expired_list }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "An issue has been created for review." >> $GITHUB_STEP_SUMMARY
        else
          echo ":white_check_mark: No expired exceptions found." >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.check_expired.outputs.has_expiring_soon }}" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### :hourglass: Expiring Within 30 Days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Exception ID | Expires On | Statement |" >> $GITHUB_STEP_SUMMARY
          echo "| ------------ | ---------- | --------- |" >> $GITHUB_STEP_SUMMARY
          echo -e "${{ steps.check_expired.outputs.expiring_soon_list }}" >> $GITHUB_STEP_SUMMARY
        fi
