name: Infracost Release Breakdown

on:
  workflow_call:
    inputs:
      currency:
        description: 'Currency to display costs in (USD, EUR, GBP, etc.)'
        required: false
        default: 'USD'
        type: string
      upload_to_release:
        description: 'Upload JSON results to the GitHub release'
        required: false
        default: true
        type: boolean
    secrets:
      INFRACOST_API_KEY:
        description: 'Infracost API key'
        required: true
      INFRACOST_APP_ID:
        description: 'The GitHub App ID for private module access'
        required: false
      INFRACOST_APP_PRIVATE_KEY:
        description: 'The GitHub App private key for private module access'
        required: false

permissions:
  contents: write
  actions: read

jobs:
  infracost_release_breakdown:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Check for private repo secrets
      id: check-secrets
      run: |
        if [ -n "$APP_CLIENT_ID" ] && [ -n "$APP_PRIVATE_KEY" ]; then
          echo "has_secrets=true" >> $GITHUB_OUTPUT
        else
          echo "has_secrets=false" >> $GITHUB_OUTPUT
        fi
      env:
        APP_CLIENT_ID: ${{ secrets.INFRACOST_APP_ID }}
        APP_PRIVATE_KEY: ${{ secrets.INFRACOST_APP_PRIVATE_KEY }}

    - name: Get Checkout Token
      id: checkout-token
      if: steps.check-secrets.outputs.has_secrets == 'true'
      uses: actions/create-github-app-token@v2
      with:
        app-id: ${{ secrets.INFRACOST_APP_ID }}
        private-key: ${{ secrets.INFRACOST_APP_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}

    - name: Configure Git for private modules
      if: steps.check-secrets.outputs.has_secrets == 'true'
      run: |
        git config --global url."https://actions:${{ steps.checkout-token.outputs.token }}@github.com".insteadOf https://github.com
        git config --global url."https://actions:${{ steps.checkout-token.outputs.token }}@github.com/".insteadOf ssh://git@github.com/

    - name: Setup Infracost
      uses: infracost/actions/setup@v3
      with:
        api-key: ${{ secrets.INFRACOST_API_KEY }}
        currency: ${{ inputs.currency }}

    - name: Generate Infracost breakdown (JSON)
      env:
        INFRACOST_ENABLE_CLOUD: false
      run: |
        infracost breakdown --path=. \
          --format=json \
          --out-file=$GITHUB_WORKSPACE/infracost_release_results.json

    - name: Generate Infracost breakdown (Markdown)
      env:
        INFRACOST_ENABLE_CLOUD: false
      run: |
        # Generate table format for the markdown file
        INFRACOST_OUTPUT=$(infracost breakdown --path=. --format=table 2>/dev/null || true)

        # Get version tag
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "unversioned")

        # Create INFRACOST.md with header and content
        cat > $GITHUB_WORKSPACE/INFRACOST.md << 'HEREDOC_END'
        # Infrastructure Cost Estimate

        HEREDOC_END

        echo "**Version:** ${LATEST_TAG}" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "## Cost Breakdown" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo '```' >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "$INFRACOST_OUTPUT" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo '```' >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "---" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "*Generated by [Infracost](https://www.infracost.io/)*" >> $GITHUB_WORKSPACE/INFRACOST.md

    - name: Upload Infracost results artifact
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: infracost-release-results
        path: |
          infracost_release_results.json
          INFRACOST.md
        retention-days: 30

    - name: Upload results to GitHub Release
      if: ${{ always() && inputs.upload_to_release }}
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Get the latest release tag
        LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
        if [ -n "$LATEST_TAG" ]; then
          gh release upload "$LATEST_TAG" infracost_release_results.json INFRACOST.md --clobber || echo "Failed to upload to release"
        else
          echo "No release found to upload results to"
        fi

    - name: Generate summary
      if: always()
      run: |
        echo "## Infracost Release Cost Breakdown" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Extract totals from JSON
        MONTHLY_COST=$(jq -r '.totalMonthlyCost // "N/A"' $GITHUB_WORKSPACE/infracost_release_results.json)
        HOURLY_COST=$(jq -r '.totalHourlyCost // "N/A"' $GITHUB_WORKSPACE/infracost_release_results.json)

        echo "| Metric | Cost |" >> $GITHUB_STEP_SUMMARY
        echo "| ------ | ---- |" >> $GITHUB_STEP_SUMMARY
        echo "| **Estimated Monthly Cost** | \$${MONTHLY_COST} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Estimated Hourly Cost** | \$${HOURLY_COST} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Full results available in the \`infracost-release-results\` artifact and INFRACOST.md" >> $GITHUB_STEP_SUMMARY
