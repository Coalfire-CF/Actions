name: Infracost Release Breakdown

on:
  workflow_call:
    inputs:
      currency:
        description: 'Currency to display costs in (USD, EUR, GBP, etc.)'
        required: false
        default: 'USD'
        type: string
      commit_infracost_md:
        description: 'Commit INFRACOST.md to the repository'
        required: false
        default: true
        type: boolean
      upload_to_release:
        description: 'Upload JSON results to the GitHub release'
        required: false
        default: true
        type: boolean
    secrets:
      INFRACOST_API_KEY:
        description: 'Infracost API key'
        required: true

permissions:
  contents: write
  actions: read

jobs:
  infracost_release_breakdown:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup Infracost
      uses: infracost/actions/setup@v3
      with:
        api-key: ${{ secrets.INFRACOST_API_KEY }}
        currency: ${{ inputs.currency }}

    - name: Generate Infracost breakdown (JSON)
      run: |
        infracost breakdown --path=. \
          --format=json \
          --out-file=$GITHUB_WORKSPACE/infracost_release_results.json

    - name: Generate Infracost breakdown (Markdown)
      run: |
        # Generate table format for the markdown file
        INFRACOST_OUTPUT=$(infracost breakdown --path=. --format=table 2>/dev/null || true)

        # Get version tag
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "unversioned")

        # Create INFRACOST.md with header and content
        cat > $GITHUB_WORKSPACE/INFRACOST.md << 'HEREDOC_END'
        # Infrastructure Cost Estimate

        HEREDOC_END

        echo "**Version:** ${LATEST_TAG}" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "## Cost Breakdown" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo '```' >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "$INFRACOST_OUTPUT" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo '```' >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "---" >> $GITHUB_WORKSPACE/INFRACOST.md
        echo "*Generated by [Infracost](https://www.infracost.io/)*" >> $GITHUB_WORKSPACE/INFRACOST.md

    - name: Commit INFRACOST.md
      if: ${{ inputs.commit_infracost_md }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Check if INFRACOST.md has changed
        if git diff --quiet $GITHUB_WORKSPACE/INFRACOST.md 2>/dev/null; then
          echo "No changes to INFRACOST.md"
        else
          git add INFRACOST.md
          git commit -m "docs: update INFRACOST.md with latest cost estimates" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }} || echo "Failed to push, may be a protected branch"
        fi

    - name: Upload Infracost results artifact
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: infracost-release-results
        path: |
          infracost_release_results.json
          INFRACOST.md
        retention-days: 30

    - name: Upload results to GitHub Release
      if: ${{ always() && inputs.upload_to_release }}
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Get the latest release tag
        LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
        if [ -n "$LATEST_TAG" ]; then
          gh release upload "$LATEST_TAG" infracost_release_results.json --clobber || echo "Failed to upload to release"
        else
          echo "No release found to upload results to"
        fi

    - name: Generate summary
      if: always()
      run: |
        echo "## Infracost Release Cost Breakdown" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Extract totals from JSON
        MONTHLY_COST=$(jq -r '.totalMonthlyCost // "N/A"' $GITHUB_WORKSPACE/infracost_release_results.json)
        HOURLY_COST=$(jq -r '.totalHourlyCost // "N/A"' $GITHUB_WORKSPACE/infracost_release_results.json)

        echo "| Metric | Cost |" >> $GITHUB_STEP_SUMMARY
        echo "| ------ | ---- |" >> $GITHUB_STEP_SUMMARY
        echo "| **Estimated Monthly Cost** | \$${MONTHLY_COST} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Estimated Hourly Cost** | \$${HOURLY_COST} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Full results available in the \`infracost-release-results\` artifact and INFRACOST.md" >> $GITHUB_STEP_SUMMARY
